# 数据库

## 数据库Database

数据库是按照数据的结构来组织、存储和管理数据的仓库。

在程序开发中，经常会有很多数据需要保存，比如用户的信息，理论上，可以将数据保存到一个对象变量里，但是变量都是保存在内存中的，一旦程序运行结束或者计算机断电时，程序中运行的数据就会丢失。

所以我们需要将程序运行的数据持久的存在磁盘里，以确保数据的安全性。

我们也可以考虑将数据保存在文件系统里，但是不太方便，我们使用数据库专门来存储数据。

## 数据库的分类

- 关系型数据库(RDBMS)：
  - MySQL、SQL Server...
  - 关系数据库里都是表
  - SQL是一门语言
- 非关系型数据库(NO SQL)：
  - MongoDB、Redis...
  - 键值对数据库
  - 文档数据库MongoDB

## MongoDB

MongoDB是为了快速开发互联网Web应用而设计的数据库系统。极简，灵活，数据模型是面向文档的，所谓的文档是一种类似json的结构，简单理解就是MongoDB这个数据库存的就是各种JSON(实际是BSON)。

MongoDB数据库结构:库，表（集合），行（文档），列（字段，域），主键（primary key）。库包含表，表包含文档。

### 安装并配置环境变量

- 官方下载地址：https://www.mongodb.com/try/download
- 分为社区版和企业版，偶数为稳定版，奇数为开发版

安装完后需要手动配置环境变量：计算机-属性-高级系统设置-环境变量

在cmd进入D:\MongoDB\bin目录下，然后执行

- `mongod -dbpath D:\MongoDB\data\db`
- `mongo`

这条命令是开启服务，它会一直运行，只要你要使用Mongodb，这个窗口就不能关）

### 基本操作指令

- `show dbs` 列出库的列表
- 'use 库的名字' 有则使用，无则新建库
- 'db' 显示当前的库
- 'db.表名/集合名.insert(JSON格式数据)'  新建表，不是严格的JSON数据，key名不需要使用引号包裹。
- 'show tables' 查看表
- 'db.user/集合名.drop()` 删除表
- 'db.dropDatabase()' 删除库，需要先进入要删除库，再执行命令

表是不需要先行定义的，当我们往一个表插入记录后，表就自动出来了。

### 增删改查

向集合中添加文档数据

- 'db.表名/集合名.insertOne({key:value,key:value...})' 添加单条数据
- 'db.表名/集合名.insertMany([{},{},{}])' 添加多条数据
- `db.表名/集合名.insert(JSON格式数据)` 多个就是数组，既可以添加单条，也可以添加多条

查询

- `db.表名/集合名.find()` 获取全部
- 'db.表面/集合名.find({key:value})` 获取带条件的数据，多个条件默认是且的关系
- 'db.表面/集合名.find({key:value},{字段：0或1})` 获取带条件的数据，返回结果隐藏部分
- ObjectID类型系统自己生成，也可以自己写，但是不能重复

逻辑运算

- `$gt` >
- `$gte`>=
- `$lt`<
- `$lte`<=
- `$ne`!=
- `$in:[1,2,3]` 集合，符合1或2或3的数据
- `默认,分割的各种条件就是且关系`
- `$or:[{条件1},{条件2}]` 集合，符合1或2或3的数据

模糊查询

- `db.表名/集合名.find({字段名:/正则/i})`

统计

- `db.表明/集合名.count()` 统计所有记录的总数
- `db.表明/集合名.find({}).count()` 统计符合条件的结果记录总数，find和count不能调换顺序

排序

- `db.表名/集合名.find().sort({age:1})` 1代表升序，age表示字段
- `db.表名/集合名.find().sort({age:-1})` -1代表降序

分页（实用）

- `db.表名/集合名.find().limit(3)`
- `db.表名/集合名.find().skip(1).limit(3)` 数字是索引
- skip表示起始位置，也就是从第2个开始，limit表示获取的记录个数（长度），顺序可以调换

更新

更新是需要条件的，没有条件在数据库上是可以更新的，但是业务上没有需求

- `db.表明/集合名.updateOne({key:value},{$set:{key:value}})' 只修改单条记录，不管有多少符合要求的只修改一个
- `db.表明/集合名.updateMany({key:value},{$set:{key:value}})' 有多少改多少
- `db.表明/集合名.updateMany({key:value},{$inc:{key:value}})' 修改单条记录，value正值自增
- `db.表明/集合名.updateMany({key:value},{$inc:{key:value}})' 有多少改多少，value负值自减

删除（了解）

删除在实际开发的时候一般不用。删除分为真删除（物理删除），假删除（逻辑删除）。为什么不用正删除，分析用户数据，数据是有价值的，政策要求直播有60天追溯期。正常做程序开发时所使用的使用删除实际是修改。

- `db.表明/集合名.deleteOne({key:value})' 删除单条记录
- `db.表明/集合名.deleteMany({key:value})' 删除多条记录
- `db.表明/集合名.deleteMany({})' 全部删除（慎用）

## node操作mongoDB

### Mongoose介绍

mongoos是Node环境下异步操作mongodb数据库的拓展，仅限Node环境下使用。

使用mongoose操作mongodb的步骤：

1. 安装mongoose
   - `npm i -S mongoose'
2. 导入模块mongoose
3. 连接mongodb数据库
4. 定义Schema（表字段约束）
   - 简单来讲就是规定了表结构的操作，比如：要求表中有username字段，该字段接着要求必填，可以继续要求该字段的类型是string，还可以要求这个字段长度是10
5. 定义model
   - mvc开发模式，模型视图控制器，m负责业务逻辑与数据库的交互部分，v负责展示给用户，c控制器负责请求与响应的整体调度
6. 使用model进行输增删改查（curd）交互操作
