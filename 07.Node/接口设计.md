# 接口设计

## 接口安全

前后端分离式开发需要接口进行数据交互，传输的数据被偷窥，被抓包，被伪造时有发生，那么如何设计一套比较安全的API接口方案。

并不是所有的接口都需要考虑安全的，有些接口是公开的，任何人只要知道地址都可以调用，对于一些项目中需要用户登录才能访问的接口才需要考虑安全问题。

一般的解决方法：

- token令牌认证（jwt）
- AK（app key）& SK（secret key）用户名和密码
- 时间戳超时验证+签名算法字符串
- URL签名（算法，非对称算法）
- 数据脱敏（防范数据库数据泄漏）
- HTTPS 数字证书（防运营商）
- IP黑/白名单，服务器层面的限制，apache,ngix
- oAuth2.0

## jwt的工作原理

jwt(json web token)，是基于token的鉴权机制，类似于http协议也是无状态的，它不需要在服务器端去保留用户的认证信息或者会话信息，为应用的拓展提供了便利。jwt具备一下几个优点：

- 因json的通用性，所以jwt是可以进行跨语言
- jwt可以在自身存储一些其他业务逻辑所必要的非敏感信息
- 便于传输，jwt的构成非常简单，字节占用很小
- 它不需要存储在服务器端保存会话信息，非常适合应用在前后端分离的项目上

使用jwt进行鉴权的工作流程：

1. 用户使用用户名密码来请求服务器
2. 服务器进行验证用户的信息（查数据库）
3. 服务器通过验证发送给用户一个token（令牌）
4. 客户端存储token（vuex + localStorage），并在每次请求时附上这个token
5. 服务端验证token值，并返回数据

JWT是由3段信息构成（头部，载荷，签名），将这三部分使用.连接在一起就组成了jwt字符串。

1. 头部（header）包含了两（可以更多）部分信息，分别是类型的声明和所使用的加密算法。一个完整头部的json：`{'typ': 'JWT','alg':'HS256'}`
2. 载荷（payload），就是存放有效信息的地方。这些有效信息分为3个部分。
   - 标准中约定声明（建议但是不强制）,签发人，使用者，签发时间，有效期...
   - 公共的声明
   - 私有的声明
3. 签名（signature），这个签证信息由三部分组成
   - 经过base64编码后的header
   - 经过base64编码后的payload
   - secret就是一个字符串，自己定义，值是什么无所谓

最终通过3个部分信息通过，进行连接就得到最终的jwt字符串。jwt不需要自己写

- secret是保存在服务器端的
- jwt的签发生成也是在服务器端的
- secret是用来进行jwt签发和jwt验证

所以，secret就是服务端的私钥，在任何场景都不应该泄漏出去，一旦其他人（包括客户端的用户）得知这个secret，那就意味着他们可以自我签发jwt，接口就没有安全性可言。

## nodejs综合应用

由于Vue项目的个人中心需要登录，此处设计两个2个接口，分别是登录和获取用户信息。用户数据可以存储在MongoDB中。

约定：库名和表名

登录操作步骤：

1. 通过MongoDB建立数据库
2. 引入express框架
3. `app.use(express.urlencoded({extended: false}))`接收post数据
4. 自定义中间件加密密码
5. `npm i -S md5`，安装md5包，用于对密码加密，用法：`md5(待加密的字符串)`，需要用‘加盐/料加密’的思想，直接md5会有被爆破的风险
6. `db.users.insert({数据})`将模拟好的数据写在mongodb数据库中
7. 获取用户提交的信息`let data = req.body`
8. 连接数据库mongoose，建立schema，产生模型
9. 查询数据库，检查是否有这个用户
10. `npm i -S jsonwebtoken`，安装token包，`jwt.sign`是jwt签发方法，参数1是载荷的数据，参数2是签名的secret

获取用户信息步骤：

1. 先去验证token
   - 把token放在头里面
   - `直接使用_token` 不推荐这种方法
   - `持有者的名字 加token`这种方式是为了让开发者能够清楚的看到jwt是发给谁的。实际上，这个持有者名并不参与验证过程。
2. 查询数据库
3. 返回给前端

## 模块化

为什么要使用模块化：遵循用户规范，后期维护方便。

遵循RMVC原则：

- R：router，路由，客户端发起请求与服务器端响应之间的映射（app.get/post/put/delete）
- M：model，模型，用来处理业务逻辑的，但是业务逻辑可以与数据库有关系
- V：view，视图，展示给用户看的页面
- C：controller，控制器，请求响应流程控制的（其中包含了若干个用于响应的方法）

现在拆分的有：路由，中间件，模型，控制器。

推荐顺序：模型，中间级，路由，控制器

各文件的存放位置：

- 模型：app/models/.js
- 中间件：app/middlewares/.js
- 路由：routers/分隔目录/.js
- 控制器：app/controllers/.js
- DB连接配置：config/.js
- Schema:database/migrations/create_xxx_table.js

