# Express框架

Express是基于Node.js平台，更加方便强大的web开发框架。Express的本质就是npm上的第三方包，快速的创建web网站的服务器或API接口的服务器。

## 安装Express

- npm i express

## 创建web服务

1. 导入express模块
2. 创建web实例
3. 定义允许访问的地址（创建路由规则）
   - 原先的输出res.end()
   - 现在的输出res.send()
4. 监听端口启动服务

## 访问调式

在测试请求的时候，get类型的请求我们我们可以直接通过地址栏访问URL来进行，对于post/put/delete等特殊类型的请求，我们往往无法通过访问地址来实现，这个时候需要使用第三方测试工具。常用的测试工具有：postman apipost apizza。以上3个任选一个，第三个为在线版本。

在前后端分离式开发中，常见的增删改查不再是纯粹的get+post两种方式请求，而是分的更加细化：

1. GET：查询请求类型
   - 取全部的数据（列表）
   - 取单个数据（详情）
2. POST：新增请求类型
   - 新增不带条件
3. PUT：修改请求类型
   - 修改是要条件的
   - 修改条件的传递时通过地址栏传递的
   - 修改的数据主体是通过请求体传递的（请求体发送方式和post一致）
4. DELETE；删除请求类型
   - 删除时需要条件的，没有请求体
   - 条件通过地址栏传递

这种对请求方法约束规范叫做retFul规范。改规范在接口设计时，前后端约定熟成的遵守。

访问地址的匹配规则：从上往下执行，需要完全匹配上请求类型和请求路径。才会走对应的回调函数。浏览器默认只会走get请求。

app.all匹配所有的请求类型，但是存在安全隐患。

### 获取query字符串

获取get传值的参数，通过req.query对象，可以访问到客户端通过查询字符串的形式发送到服务器的参数。

- `app.get('/', (req, res) => console.log(req.query))`

### 动态参数的传递

Express也支持类似Vue中的动态路由的形式传递，传递的参数通过req.params对象可以访问到。

### 静态资源服务器托管

express提供了一个非常好用的方法，express.static()，通过该方法，可以非常方便的创建一个静态web资源服务器。

- app.use(express,static('public'))

express还支持给静态资源文件创建一个虚拟的文件前缀，实际上文件系统中并不存在，可以使用express.static函数指定一个虚拟的静态目录。

- app.use('/static',express.static('public'))

前缀的使用意义：可以迷惑别人，一定程度上阻止别人猜测我们服务器的目录结构。可以帮助我们更好的组织和管理静态资源。

app.use()一般情况下都写在具体的路由监听之前。

## 路由

在express中，路由指的是客户端发起的请求与服务器处理方法之间的映射关系。映射就是一一对应的关系。

### 定义路由

1. 请求的类型（方法）
2. 请求的uri（地址）
3. 对应的处理函数

当客户端到达服务器端后，先经过路由规则匹配，只有匹配成功后，才会调用对应的处理函数。在匹配时，会按照路由的顺序进行匹配，如果请求的类型和URL同时匹配成功。则express会将这次请求，转交给对应的函数进行处理。

### 路由模块化

将路由模块化，以模块（js文件）为单位进行管理，物以类聚。将原本可能写在一个文件中路由规则，拆分成若干个路由文件。一个js文件就是一个模块。

核心思想；能拆就拆，解耦合，高内聚，低耦合。

路由模块化的处理步骤：

1. 创建独立的js空白文件（最后是统一在一个目录下），该文件即路由模块化文件
2. 在第一步的js文件中使用express.Router()方法创建路由模块对象
3. 使用路由对象完成路由规则的对应的业务编写
4. 使用模块化导出（module.exports = router）
5. 在主入口文件中能够使用app.use方法来注册定义的路由模块，支持前缀的使用
   - app.use('前缀',路由模块化路由)

## 中间件

中间件（middleware）可以理解为业务流程的中间处理环节。express中，当一个请求达到服务器之后，可以在给客户端响应之前，连续调用多个中间件，来对本次请求和返回响应数据进行处理。客户端请求->中间件1->中间件2->中间件n->本次请求匹配路由->响应客户端。

中间件的本质就是一个function

### 中间件的分类

1. 内置中间件，express本身自带的无需npm安装
   - express.static()
2. 第三方中间件，非官方内置，可以通过npm安装并配置
   - body-parser；解析post数据
3. 自定义中间件：开发者自己编写的

- 应用级别：app.use()
- 路由级别：router.use()
- 全局路由：app.use(中间件)
- 局部路由：app.请求方法（地址,[中间件]回调函数）

### 内置中间件

1. `app.use('前缀',express.static('托管目录地址'))`
   - 静态资源管理的中间件。
2. `express.json`
   - 作用：接收json格式提交的数据
   - 兼容性：express>=4.16.0
   - app.use(express.json())
   - 其在接收完数据后，会将数据的对象形式挂载到req请求对象的body属性上
3. express.urlencoded
   - 作用：处理post表单数据
   - 兼容性问题：express>=4.16.0
   - app.use(express.urlencodeed({extended:false}))
   - extended:false表示要求在解析数据的时候使用querystring库，ture表示使用qs库，前面一个库会剔除传递过来的方法和对象。
   - 其在接收完数据后，会将数据的对象形式挂载到req对象的body属性上

### 自定义中间件

自定义中间件，其本质就是定义一个处理请求的函数。此函数的除了request和response参数外还必须包含一个next参数，此参数作用让中间件能够让流程向下执行直到匹配到路由中发送响应给客户端。也可以通过request对象添加属性来进行中间件数据的向下传递。

在整个请求链路中，所有的中间件与最终的路由共用一份req和res

步骤：

1. 定义中间件（本质函数）
2. 监听req的data事件
3. 监听req的end事件
4. 使用querystrig的模块来解析请求体数据
5. 将解析出来的请求体对象挂载到req.body上
6. 将自定义中间件封装为模块（可选，建议做）

### 第三方中间件

在express中，允许我们使用第三方的中间件来进行对数据进行处理，可以使用第三方中间件来接收post数据，body-parse中间件。

1. 安装第三方中间件post-parse
   - npm i -s body-parse
2. 应用文件中导入body-parse
3. 通过中间件调用app.use(body.urlencoded({extend:false}))
4. 在匹配的路由中通过req.body获取post数据

这个中间件已经弃用

### 错误类型中间件

本质上属于自定义中间件，但是有些特殊。

#### 异常中间件

作用：专门用来捕获整个项目中发生的异常错误，从而防止项目异常崩溃的问题产生。（友好显示异常）

格式：错误级别中间件的函数参数中，必须有4个形参，分别是(err,req,res,next)，err参数包含了错误的信息，err.message属性中就包含了错误的文本信息，这个信息可以在中间件中输出给用户看。

#### 404处理中间件

作用：用于404的请求响应

## cookie和session（会话控制）

无状态协议：生活中一些商家开设的会员卡服务，记名的会员卡和不记名的会员卡，不记名的就类似无状态协议的情况。

需要一些手段记录用户的一些列操作，就是cookie和session。

cookie：

- 存储在浏览器上（客户端）
- 大小限制，4kb左右
- 有被用户修改，删除的风险

session：

- 存储在服务器端
- 没有被用户随意修改的风险，相对于cookie更加安全
- 默认情况下，是基于cookie实现的，会将session会话id给cookie，id存储客户端上
- session的id是可以被删除的，解决办法是通过后端技术去实现
- 理论上，只有磁盘空间够，session是可以放很多数据的

### cookie

http是一个无状态协议，客户端每次发出请求时，下一次请求得不到上一次请求的数据。所以我们需要将上一次请求和下一次请求的数据关联起来，如用户登录成功后，跳转到其他页面时，其他页面是怎么知道该用户已经登录了呢，此时就可以使用cookie的值来判断用户是否登录，cookie可以保存用户数据。

cookie是一个由浏览器（存储）和服务器（产生）共同协作实现的，cookie存储于浏览器中。cookie分为如下几步实现：

- 服务器端向客户端发送cookie并指定cookie的过期时间
- 浏览器将cookie保存起来
- 每次请求都会将cookie发送服务器端，在cookie没有过期时间内，服务器都可以得到cookie中的值

express中操作的cookie使用cookie-parser模块，npm i -s cookie-parser

cookie-parser模块也是中间件，设置cookie通过`res.cookie(name,value,[选项])`，读cookie的时候通过req.cookie对象来获取。

### session

cookie操作很方便，但是安全性不高，cookie中的所有数据存储在客户端浏览器中，数据很容易被伪造，所以一些重要的数据就不能放在cookie中，而且cookie还有一个缺点就是不能存放太多数据，一般就4kb左右，为了解决这些问题，session产生了，session中的数据保留在服务端。数据放在cookie中式不安全的，在cookie中存放一个sessionid值，该值会和服务器端产生一种映射关系，如果sessionid被篡改的话，他就不会与服务器端数据产生映射，因此安全性更好，并且session的有效期比较短，一般都是20分钟左右，在20分钟内，客户端和服务器没有产生交互，服务器端就会将数据删除。


